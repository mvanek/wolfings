{% macro timediff(t1, t2) %}
    {% set t = t1 - t2 %}
    {% set days = t.days %}
    {% set hours = t.seconds//3600 %}
    {% set minutes = (t.seconds - 3600*hours)//60 %}
    {% set seconds = t.seconds - 60*minutes - 3600*hours %}

    {% if days %}
        {{ days }} days
    {% endif %}

    {% if hours %}
        {{ hours }} hours
    {% endif %}

    {% if minutes %}
        {{ minutes }} minutes
    {% endif %}

    {% if seconds %}
        {{ seconds }} seconds
    {% endif %}
{% endmacro %}

{% macro coupon_snip(c, now, user=None, editable=False) %}
    {% set business = c.business.get() %}

    {% if c.start < now and now < c.end %}
        {% set class='active' %}
    {% elif now < c.start %}
        {% set class='inactive' %}
    {% else %}
        {% set class='expired' %}
    {% endif %}

    <article class="{{class}} coupon" id="c{{c.key.id()}}">

        <header>
            <a href="/coupon/{{c.key.id()}}/">
                {% if business.name %}
                    {{ business.name }} -
                {% endif %}
                {{ c.name }}
            </a>
        </header>
        <p>{{ c.start.strftime('%c') }} - {{ c.end.strftime('%c') }}</p>

        <div class="right">
        {% if editable %}
            <button class="trash" id="button_c{{ c.key.id() }}">TRASH</button>
            <script>
                WOLFINGS.import('coupon_snip', function() {
                    var button = document.getElementById('button_c{{ c.key.id() }}');
                    WOLFINGS.handlers.click_trash_coupon( button );
                });
            </script>
        {% elif user %}
            {% if c.key in user.held_coupons %}
                <button class="inactive">CLAIMED</button>
            {% elif now < c.end %}
                <button class="claim" id="button_c{{ c.key.id() }}">CLAIM</button>
                <script>
                    WOLFINGS.import('coupon_snip', function() {
                        var button = document.getElementById('button_c{{ c.key.id() }}');
                        WOLFINGS.handlers.click_claim_coupon( button );
                    });
                </script>
            {% endif %}
        {% endif %}
        </div>
        {% if c.start < now and now < c.end %}
            <p>Available for {{ timediff(c.end, now) }}</p>
        {% elif now < c.start %}
            <p>Available in {{ timediff(c.start, now) }} for {{ timediff(c.end, c.start) }}</p>
        {% else %}
            <p>Offer has expired</p>
        {% endif %}

    </article>
{% endmacro %}
